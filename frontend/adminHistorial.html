<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de Pedidos</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <!-- jsPDF library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            padding-bottom: 80px;
        }

        nav {
            background-color: #ffa755;
        }

        .card {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .alert {
            margin-top: 20px;
        }

        .card-header {
            background-color: #ffa755;
            color: white;
            font-weight: bold;
        }

        .floating-buttons {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }

        .btn-floating {
            background-color: #ffa755;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .btn-floating:hover {
            background-color: #ff9635;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
            color: white;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .status-entregado {
            background-color: #28a745;
            color: white;
        }

        .status-pendiente {
            background-color: #ffc107;
            color: black;
        }

        .status-en-proceso {
            background-color: #17a2b8;
            color: white;
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <img src="img/logo.png" alt="Logo" style="height: 40px;">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav"></div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <h2 class="mb-4 text-center">Historial de Pedidos</h2>
        <div id="pedido-list">
            <!-- Los pedidos se cargarán aquí divididos por días -->
        </div>
    </div>

    <!-- Botones flotantes -->
    <div class="floating-buttons">
        <button onclick="generatePDF()" class="btn-floating">
            <i class="bi bi-download"></i>
            Descargar PDF
        </button>
    </div>

    <!-- Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>

    <script>
        let allPedidos = [];
        let productosNombres = {};

        document.addEventListener('DOMContentLoaded', function () {
            const pedidoList = document.getElementById('pedido-list');

            // Fetch de todos los pedidos sin filtrar por estado
            fetch('https://vision-digital-api.vercel.app/api/pedidos')
                .then(response => response.json())
                .then(data => {
                    // Guardar todos los pedidos
                    allPedidos = data;
                    
                    if (data.length === 0) {
                        pedidoList.innerHTML = `<div class="alert alert-info text-center" role="alert">
                            No hay pedidos registrados.
                        </div>`;
                    } else {
                        const pedidosPorFecha = data.reduce((acc, pedido) => {
                            let fecha;
                            try {
                                fecha = new Date(pedido.fecha).toLocaleDateString('es-ES') || "Fecha desconocida";
                            } catch {
                                fecha = "Fecha desconocida";
                            }

                            if (!acc[fecha]) acc[fecha] = [];
                            acc[fecha].push(pedido);
                            return acc;
                        }, {});

                        displayPedidos(pedidosPorFecha);
                    }
                })
                .catch(error => {
                    console.error('Error al cargar los pedidos:', error);
                    pedidoList.innerHTML = `<div class="alert alert-danger text-center" role="alert">
                        Error al cargar los pedidos. Intenta nuevamente más tarde.
                    </div>`;
                });
        });

        function getStatusBadgeClass(estado) {
            switch (estado.toLowerCase()) {
                case 'entregado':
                    return 'status-entregado';
                case 'pendiente':
                    return 'status-pendiente';
                case 'en proceso':
                    return 'status-en-proceso';
                default:
                    return '';
            }
        }

        function displayPedidos(pedidosPorFecha) {
            const pedidoList = document.getElementById('pedido-list');
            pedidoList.innerHTML = '';

            for (const [fecha, pedidos] of Object.entries(pedidosPorFecha)) {
                const fechaSection = document.createElement('div');
                fechaSection.className = 'mb-4';
                fechaSection.innerHTML = `<h4 class="mb-3">${fecha}</h4>`;

                pedidos.forEach(pedido => {
                    const pedidoCard = document.createElement('div');
                    pedidoCard.className = 'col-md-4 mb-4';

                    let productos = [];
                    try {
                        const cleanedProductos = pedido.productos
                            .replace(/^\s*"/, '')
                            .replace(/"\s*$/, '')
                            .replace(/\\/g, '');

                        productos = JSON.parse(cleanedProductos);
                    } catch (error) {
                        console.error('Error al parsear productos:', error);
                    }

                    const productIds = productos.map(prod => prod.id_producto).join(',');

                    fetch(`https://vision-digital-api.vercel.app/api/productos?id=${productIds}`)
                        .then(response => response.json())
                        .then(productData => {
                            productData.forEach(prod => {
                                productosNombres[prod.id_producto] = prod.nombre_producto;
                            });

                            const productosDisplay = Array.isArray(productos)
                                ? productos.map(prod => `Nombre: ${productosNombres[prod.id_producto] || 'Desconocido'} (Cantidad: ${prod.cantidad})`).join(', ')
                                : 'Sin productos';

                            const cantidadTotal = Array.isArray(productos)
                                ? productos.reduce((total, prod) => total + prod.cantidad, 0)
                                : 0;

                            const statusBadgeClass = getStatusBadgeClass(pedido.estado);

                            pedidoCard.innerHTML = `
                                <div class="card shadow">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <span>Pedido #${pedido.id_pedido}</span>
                                        <span class="status-badge ${statusBadgeClass}">${pedido.estado}</span>
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text"><strong>Cliente ID:</strong> ${pedido.id_usuario}</p>
                                        <p class="card-text"><strong>Productos:</strong> ${productosDisplay}</p>
                                        <p class="card-text"><strong>Cantidad Total:</strong> ${cantidadTotal}</p>
                                        <p class="card-text"><strong>Total:</strong> $${pedido.total}</p>
                                        <p class="card-text"><strong>Dirección:</strong> ${pedido.direccion}</p>
                                        <p class="card-text"><strong>Código Postal:</strong> ${pedido.codigo_postal}</p>
                                        <p class="card-text"><strong>Ciudad:</strong> ${pedido.ciudad}</p>
                                        <p class="card-text"><strong>Provincia:</strong> ${pedido.provincia}</p>
                                        <p class="card-text"><strong>Fecha:</strong> ${new Date(pedido.fecha).toLocaleString('es-ES')}</p>
                                    </div>
                                </div>
                            `;

                            fechaSection.appendChild(pedidoCard);
                        })
                        .catch(error => {
                            console.error('Error al obtener nombres de productos:', error);
                        });
                });

                pedidoList.appendChild(fechaSection);
            }
        }

        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Configuración del documento
            doc.setFont('helvetica');
            doc.setFontSize(20);
            doc.text('Historial de Pedidos', 105, 15, { align: 'center' });
            
            // Preparar datos para la tabla
            const tableData = allPedidos.map(pedido => {
                let productos = [];
                try {
                    const cleanedProductos = pedido.productos
                        .replace(/^\s*"/, '')
                        .replace(/"\s*$/, '')
                        .replace(/\\/g, '');
                    productos = JSON.parse(cleanedProductos);
                } catch (error) {
                    console.error('Error al parsear productos:', error);
                }

                const productosStr = Array.isArray(productos)
                    ? productos.map(prod => `${productosNombres[prod.id_producto] || 'Desconocido'} (${prod.cantidad})`).join('\n')
                    : 'Sin productos';

                return [
                    pedido.id_pedido,
                    new Date(pedido.fecha).toLocaleDateString('es-ES'),
                    pedido.id_usuario,
                    productosStr,
                    `$${pedido.total}`,
                    pedido.estado
                ];
            });

            // Generar la tabla
            doc.autoTable({
                head: [['ID', 'Fecha', 'Cliente', 'Productos', 'Total', 'Estado']],
                body: tableData,
                startY: 25,
                styles: { fontSize: 8 },
                columnStyles: {
                    0: { cellWidth: 20 },
                    1: { cellWidth: 25 },
                    2: { cellWidth: 20 },
                    3: { cellWidth: 60 },
                    4: { cellWidth: 25 },
                    5: { cellWidth: 25 }
                },
                didDrawPage: function (data) {
                    // Agregar número de página
                    doc.setFontSize(10);
                    doc.text(
                        `Página ${doc.internal.getCurrentPageInfo().pageNumber}/${doc.internal.getNumberOfPages()}`,
                        doc.internal.pageSize.width - 20,
                        doc.internal.pageSize.height - 10
                    );
                }
            });

            // Guardar el PDF
            doc.save('historial-pedidos.pdf');
        }
    </script>
</body>

</html>
