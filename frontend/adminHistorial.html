<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de Pedidos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        nav {
            background-color: #ffa755;
        }

        .card {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .alert {
            margin-top: 20px;
        }

        .card-header {
            background-color: #ffa755;
            color: white;
            font-weight: bold;
        }

        .download-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background-color: #ffa755;
            border: none;
        }

        .download-btn:hover {
            background-color: #ff9635;
        }

        .filter-section {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <img src="img/logo.png" alt="Logo" style="height: 40px;">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav"></div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <h2 class="mb-4 text-center">Historial de Pedidos</h2>

        <!-- Filtros -->
        <div class="filter-section">
            <div class="row">
                <div class="col-md-4">
                    <label for="dateFrom" class="form-label">Desde:</label>
                    <input type="date" class="form-control" id="dateFrom">
                </div>
                <div class="col-md-4">
                    <label for="dateTo" class="form-label">Hasta:</label>
                    <input type="date" class="form-control" id="dateTo">
                </div>
                <div class="col-md-4">
                    <label for="estadoFilter" class="form-label">Estado:</label>
                    <select class="form-select" id="estadoFilter">
                        <option value="">Todos</option>
                        <option value="pendiente">Pendiente</option>
                        <option value="en_proceso">En Proceso</option>
                        <option value="entregado">Entregado</option>
                        <option value="cancelado">Cancelado</option>
                    </select>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <button class="btn btn-primary" onclick="aplicarFiltros()">
                        <i class="bi bi-funnel"></i> Aplicar Filtros
                    </button>
                </div>
            </div>
        </div>

        <div id="pedido-list">
            <!-- Los pedidos se cargarán aquí -->
        </div>

        <!-- Botón de Descarga -->
        <button class="btn btn-lg btn-primary download-btn" onclick="descargarPedidos()">
            <i class="bi bi-download"></i> Descargar Historial
        </button>
    </div>

    <!-- Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>

    <script>
        let todosLosPedidos = [];

        document.addEventListener('DOMContentLoaded', function () {
            cargarPedidos();
        });

        function cargarPedidos() {
            const pedidoList = document.getElementById('pedido-list');

            // Fetch de todos los pedidos desde la API del historial
            fetch('https://vision-digital-api.vercel.app/api/historial-pedidos')
                .then(response => response.json())
                .then(data => {
                    todosLosPedidos = data;
                    mostrarPedidos(data);
                })
                .catch(error => {
                    console.error('Error al cargar los pedidos:', error);
                    pedidoList.innerHTML = `<div class="alert alert-danger text-center" role="alert">
                        Error al cargar los pedidos. Intenta nuevamente más tarde.
                    </div>`;
                });
        }

        function mostrarPedidos(pedidos) {
            const pedidoList = document.getElementById('pedido-list');
            pedidoList.innerHTML = '';

            if (pedidos.length === 0) {
                pedidoList.innerHTML = `<div class="alert alert-info text-center" role="alert">
                    No hay pedidos que coincidan con los filtros seleccionados.
                </div>`;
                return;
            }

            // Agrupar pedidos por fecha
            const pedidosPorFecha = agruparPedidosPorFecha(pedidos);
            
            // Mostrar pedidos agrupados
            for (const [fecha, pedidosDelDia] of Object.entries(pedidosPorFecha)) {
                mostrarPedidosDelDia(fecha, pedidosDelDia, pedidoList);
            }
        }

        function agruparPedidosPorFecha(pedidos) {
            return pedidos.reduce((acc, pedido) => {
                const fecha = new Date(pedido.fecha).toLocaleDateString('es-ES');
                if (!acc[fecha]) acc[fecha] = [];
                acc[fecha].push(pedido);
                return acc;
            }, {});
        }

        function mostrarPedidosDelDia(fecha, pedidos, container) {
            const fechaSection = document.createElement('div');
            fechaSection.className = 'mb-4';
            fechaSection.innerHTML = `<h4 class="mb-3">${fecha}</h4>`;

            const row = document.createElement('div');
            row.className = 'row';

            pedidos.forEach(pedido => {
                const col = document.createElement('div');
                col.className = 'col-md-4 mb-4';
                
                let productosHTML = '';
                if (pedido.productos && Array.isArray(pedido.productos)) {
                    productosHTML = pedido.productos
                        .map(prod => `${prod.nombre} (${prod.cantidad})`)
                        .join('<br>');
                }

                col.innerHTML = `
                    <div class="card shadow">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Pedido #${pedido.id_pedido}</span>
                            <span class="badge ${getEstadoBadgeClass(pedido.estado)}">${pedido.estado}</span>
                        </div>
                        <div class="card-body">
                            <p class="card-text"><strong>Cliente:</strong> ${pedido.nombre_cliente}</p>
                            <p class="card-text"><strong>Productos:</strong><br>${productosHTML}</p>
                            <p class="card-text"><strong>Total:</strong> $${pedido.total}</p>
                            <p class="card-text"><strong>Dirección:</strong> ${pedido.direccion}</p>
                            <small class="text-muted">Fecha: ${new Date(pedido.fecha).toLocaleString()}</small>
                        </div>
                    </div>
                `;

                row.appendChild(col);
            });

            fechaSection.appendChild(row);
            container.appendChild(fechaSection);
        }

        function getEstadoBadgeClass(estado) {
            const clases = {
                'pendiente': 'bg-warning',
                'en_proceso': 'bg-info',
                'entregado': 'bg-success',
                'cancelado': 'bg-danger'
            };
            return clases[estado] || 'bg-secondary';
        }

        function aplicarFiltros() {
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const estado = document.getElementById('estadoFilter').value;

            let pedidosFiltrados = todosLosPedidos;

            if (dateFrom) {
                pedidosFiltrados = pedidosFiltrados.filter(pedido => 
                    new Date(pedido.fecha) >= new Date(dateFrom)
                );
            }

            if (dateTo) {
                pedidosFiltrados = pedidosFiltrados.filter(pedido => 
                    new Date(pedido.fecha) <= new Date(dateTo)
                );
            }

            if (estado) {
                pedidosFiltrados = pedidosFiltrados.filter(pedido => 
                    pedido.estado === estado
                );
            }

            mostrarPedidos(pedidosFiltrados);
        }

        function descargarPedidos() {
            const pedidosFiltrados = [...todosLosPedidos]; // Usar los pedidos actualmente mostrados
            
            // Formatear datos para CSV
            const csvContent = formatearPedidosParaCSV(pedidosFiltrados);
            
            // Crear y descargar el archivo
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `historial_pedidos_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }

        function formatearPedidosParaCSV(pedidos) {
            const headers = ['ID Pedido', 'Fecha', 'Cliente', 'Productos', 'Total', 'Estado', 'Dirección'];
            const rows = pedidos.map(pedido => {
                const productos = Array.isArray(pedido.productos) 
                    ? pedido.productos.map(p => `${p.nombre}(${p.cantidad})`).join('; ')
                    : '';
                
                return [
                    pedido.id_pedido,
                    new Date(pedido.fecha).toLocaleString(),
                    pedido.nombre_cliente,
                    productos,
                    pedido.total,
                    pedido.estado,
                    pedido.direccion
                ].map(value => `"${value}"`).join(',');
            });

            return [headers.join(','), ...rows].join('\n');
        }
    </script>
</body>
</html>
